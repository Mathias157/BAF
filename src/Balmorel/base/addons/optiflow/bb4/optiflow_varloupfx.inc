LOOP((IY411,IA,IPROCFROM,IPROCTO,FLOW)$FLOWFROMTOPROC(IY411,IA,IPROCFROM,IPROCTO,FLOW),
  IF(FLOWFROMTOPROC(IY411,IA,IPROCFROM,IPROCTO,FLOW) AND(PROCKAPDATA(IY411,IPROCFROM,FLOW,'IFLOWINOUT_OUT') AND PROCKAPFX(IY411,IA,IPROCFROM,FLOW,'IFLOWINOUT_OUT') AND (NOT APROCKAPNEW(IY411,IA,IPROCFROM)) AND (NOT PROCSTORAGE(IPROCFROM)) AND (NOT PROCSTORAGE_Y(IPROCFROM))),
    VFLOW.UP(IY411,IA,IPROCFROM,IPROCTO,FLOW,S,T) = PROCKAPFX(IY411,IA,IPROCFROM,FLOW,'IFLOWINOUT_OUT'));
  IF(FLOWFROMTOPROC(IY411,IA,IPROCFROM,IPROCTO,FLOW) AND (PROCKAPDATA(IY411,IPROCTO,FLOW,'IFLOWINOUT_IN') AND PROCKAPFX(IY411,IA,IPROCTO,FLOW,'IFLOWINOUT_IN')     AND (NOT APROCKAPNEW(IY411,IA,IPROCTO))   AND (NOT PROCSTORAGE_Y(IPROCTO)) AND (NOT PROCSTORAGE_Y(IPROCTO))),
         VFLOW.UP(IY411,IA,IPROCFROM,IPROCTO,FLOW,S,T) = PROCKAPFX(IY411,IA,IPROCTO,FLOW,'IFLOWINOUT_IN'););
);

LOOP((IY411,IA,IPROCFROM,PROCSTORAGE,FLOW)$FLOWFROMTOPROC(IY411,IA,IPROCFROM,PROCSTORAGE,FLOW),
  IF(FLOWFROMTOPROC(IY411,IA,IPROCFROM,PROCSTORAGE,FLOW) AND (PROCKAPDATA(IY411,PROCSTORAGE,FLOW,'IFLOWINOUT_IN') AND PROCSTORAGEBOUND(IY411,IA,PROCSTORAGE)  AND (NOT APROCKAPNEW(IY411,IA,PROCSTORAGE))),
         VSTORAGEVOL.UP(IY411,IA,PROCSTORAGE,FLOW,S,T)= PROCSTORAGEBOUND(IY411,IA,PROCSTORAGE););
);

LOOP((IY411,IA,IPROCFROM,PROCSTORAGE_Y,FLOW)$FLOWFROMTOPROC(IY411,IA,IPROCFROM,PROCSTORAGE_Y,FLOW),
  IF(FLOWFROMTOPROC(IY411,IA,IPROCFROM,PROCSTORAGE_Y,FLOW) AND (PROCKAPDATA(IY411,PROCSTORAGE_Y,FLOW,'IFLOWINOUT_IN') AND PROCSTORAGEBOUND(IY411,IA,PROCSTORAGE_Y)  AND (NOT APROCKAPNEW(IY411,IA,PROCSTORAGE_Y))),
         VSTORAGEVOL_Y.UP(IY411,IA,PROCSTORAGE_Y,FLOW,S)= PROCSTORAGEBOUND(IY411,IA,PROCSTORAGE_Y););
);


*Fix those Source, Sink of Buffer Flows that have been given a value in SOSIBUBOUND and SOSIBUFLOW_VAR_T.
VFLOWSOURCE.LO(IY411,IA,PROCSOURCE,FLOW,S,T)$(ILEAVEPROC(IY411,IA,PROCSOURCE,FLOW) AND ISOSIBUFLOW_SUMST(IA,PROCSOURCE,FLOW) AND SOSIBUBOUND(IY411,IA,PROCSOURCE,FLOW,'ILOUPFX_LO'))
   = (SOSIBUBOUND(IY411,IA,PROCSOURCE,FLOW,'ILOUPFX_LO')*SOSIBUFLOW_VAR_T(IA,PROCSOURCE,FLOW,S,T))/ ISOSIBUFLOW_SUMST(IA,PROCSOURCE,FLOW);
VFLOWSOURCE.UP(IY411,IA,PROCSOURCE,FLOW,S,T)$(ILEAVEPROC(IY411,IA,PROCSOURCE,FLOW) AND ISOSIBUFLOW_SUMST(IA,PROCSOURCE,FLOW) AND SOSIBUBOUND(IY411,IA,PROCSOURCE,FLOW,'ILOUPFX_UP'))
   = (SOSIBUBOUND(IY411,IA,PROCSOURCE,FLOW,'ILOUPFX_UP')*SOSIBUFLOW_VAR_T(IA,PROCSOURCE,FLOW,S,T))/ ISOSIBUFLOW_SUMST(IA,PROCSOURCE,FLOW);
VFLOWSOURCE.FX(IY411,IA,PROCSOURCE,FLOW,S,T)$(ILEAVEPROC(IY411,IA,PROCSOURCE,FLOW) AND ISOSIBUFLOW_SUMST(IA,PROCSOURCE,FLOW) AND SOSIBUBOUND(IY411,IA,PROCSOURCE,FLOW,'ILOUPFX_FX'))
   = (SOSIBUBOUND(IY411,IA,PROCSOURCE,FLOW,'ILOUPFX_FX')*SOSIBUFLOW_VAR_T(IA,PROCSOURCE,FLOW,S,T))/ ISOSIBUFLOW_SUMST(IA,PROCSOURCE,FLOW);
VFLOWSINK.LO(IY411,IA,PROCSINK,FLOW,S,T)$(IENTERPROC(IY411,IA,PROCSINK,FLOW) AND ISOSIBUFLOW_SUMST(IA,PROCSINK,FLOW) AND SOSIBUBOUND(IY411,IA,PROCSINK,FLOW,'ILOUPFX_LO'))
   = (SOSIBUBOUND(IY411,IA,PROCSINK,FLOW,'ILOUPFX_LO')*SOSIBUFLOW_VAR_T(IA,PROCSINK,FLOW,S,T)) / ISOSIBUFLOW_SUMST(IA,PROCSINK,FLOW); !! SEEMS
VFLOWSINK.UP(IY411,IA,PROCSINK,FLOW,S,T)$(IENTERPROC(IY411,IA,PROCSINK,FLOW) AND ISOSIBUFLOW_SUMST(IA,PROCSINK,FLOW) AND SOSIBUBOUND(IY411,IA,PROCSINK,FLOW,'ILOUPFX_UP'))
   = (SOSIBUBOUND(IY411,IA,PROCSINK,FLOW,'ILOUPFX_UP')*SOSIBUFLOW_VAR_T(IA,PROCSINK,FLOW,S,T)) / ISOSIBUFLOW_SUMST(IA,PROCSINK,FLOW); !! SEEMS
VFLOWSINK.FX(IY411,IA,PROCSINK,FLOW,S,T)$(IENTERPROC(IY411,IA,PROCSINK,FLOW) AND ISOSIBUFLOW_SUMST(IA,PROCSINK,FLOW) AND SOSIBUBOUND(IY411,IA,PROCSINK,FLOW,'ILOUPFX_FX'))
   = (SOSIBUBOUND(IY411,IA,PROCSINK,FLOW,'ILOUPFX_FX')*SOSIBUFLOW_VAR_T(IA,PROCSINK,FLOW,S,T)) / ISOSIBUFLOW_SUMST(IA,PROCSINK,FLOW); !! SEEMS
VFLOWBUFFER.LO(IY411,IA,PROCBUFFER,FLOW,S,T)$((IENTERPROC(IY411,IA,PROCBUFFER,FLOW) OR ILEAVEPROC(IY411,IA,PROCBUFFER,FLOW)) AND ISOSIBUFLOW_SUMST(IA,PROCBUFFER,FLOW) AND SOSIBUBOUND(IY411,IA,PROCBUFFER,FLOW,'ILOUPFX_LO'))
    = (SOSIBUBOUND(IY411,IA,PROCBUFFER,FLOW,'ILOUPFX_LO')*SOSIBUFLOW_VAR_T(IA,PROCBUFFER,FLOW,S,T)) / ISOSIBUFLOW_SUMST(IA,PROCBUFFER,FLOW);
VFLOWBUFFER.UP(IY411,IA,PROCBUFFER,FLOW,S,T)$((IENTERPROC(IY411,IA,PROCBUFFER,FLOW) OR ILEAVEPROC(IY411,IA,PROCBUFFER,FLOW)) AND ISOSIBUFLOW_SUMST(IA,PROCBUFFER,FLOW) AND SOSIBUBOUND(IY411,IA,PROCBUFFER,FLOW,'ILOUPFX_UP'))
    = (SOSIBUBOUND(IY411,IA,PROCBUFFER,FLOW,'ILOUPFX_UP')*SOSIBUFLOW_VAR_T(IA,PROCBUFFER,FLOW,S,T)) / ISOSIBUFLOW_SUMST(IA,PROCBUFFER,FLOW);
VFLOWBUFFER.FX(IY411,IA,PROCBUFFER,FLOW,S,T)$((IENTERPROC(IY411,IA,PROCBUFFER,FLOW) OR ILEAVEPROC(IY411,IA,PROCBUFFER,FLOW)) AND ISOSIBUFLOW_SUMST(IA,PROCBUFFER,FLOW) AND SOSIBUBOUND(IY411,IA,PROCBUFFER,FLOW,'ILOUPFX_FX'))
    = (SOSIBUBOUND(IY411,IA,PROCBUFFER,FLOW,'ILOUPFX_FX')*SOSIBUFLOW_VAR_T(IA,PROCBUFFER,FLOW,S,T)) / ISOSIBUFLOW_SUMST(IA,PROCBUFFER,FLOW);

VPROCKAPNEW.FX(IY411,IA,IPROCFROM)$((NOT IAPROCKAPNEW(IY411,IA,IPROCFROM)) AND (SUM((IPROCTO,FLOW)$PROCKAPDATA(IY411,IPROCFROM,FLOW,'IFLOWINOUT_OUT'),FLOWFROMTOPROC(IY411,IA,IPROCFROM,IPROCTO,FLOW))))=0;
VPROCKAPNEW.FX(IY411,IA,IPROCTO)$((NOT IAPROCKAPNEW(IY411,IA,IPROCTO)) AND (SUM((IPROCFROM,FLOW)$PROCKAPDATA(IY411,IPROCTO,FLOW,'IFLOWINOUT_IN'),FLOWFROMTOPROC(IY411,IA,IPROCFROM,IPROCTO,FLOW))))=0;

*VFLOW.FX(IY411,IA,IPROCFROM,IPROCTO,FLOW,S,T)$(PROCSTORAGE(IPROCFROM) AND (NOT IAPROCKAPNEW(IY411,IA,IPROCFROM)) AND (NOT PROCKAPFX(IY411,IA,IPROCFROM,FLOW,'IFLOWINOUT_OUT')) AND FLOWFROMTOPROC(IY411,IA,IPROCFROM,IPROCTO,FLOW))=0;
*VFLOW.FX(IY411,IA,IPROCFROM,IPROCTO,FLOW,S,T)$(PROCSTORAGE(IPROCTO) AND (NOT IAPROCKAPNEW(IY411,IA,IPROCTO)) AND (NOT PROCKAPFX(IY411,IA,IPROCTO,FLOW,'IFLOWINOUT_IN')) AND FLOWFROMTOPROC(IY411,IA,IPROCFROM,IPROCTO,FLOW))=0;




