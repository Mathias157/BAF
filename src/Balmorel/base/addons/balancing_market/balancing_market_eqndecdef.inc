*Balancing market introduced by Juan Gea-Bermudez and Polyneikis Kanellas

*Fixing heat side
$ifi not %NOHEATMARKET%==yes $goto NO_HEATMARKET
EQUATION QBMGH_T(YYY,AAA,GGG,SSS)       'Equation forcing heat production in SSS to match previous runs. Mind the timesteps used in the runs.';

QBMGH_T(IY411,IA,IGEH,IS3)$(IAGK_HASORPOT(IY411,IA,IGEH))..
SUM(T,VGH_T(IY411,IA,IGEH,IS3,T)-GH_T(IY411,IA,IGEH,IS3,T))
=E=
0
$include "../../base/addons/_hooks/qmbgh_t.inc"
;


$label NO_HEATMARKET

$ifi not %BALANCINGRUNPURPOSE%==TSOREDISPATCH $goto NO_TSOREDISPATCH
EQUATION QVGE_T_DOWN1(YYY,AAA,GGG,SSS,TTT) 'Equation 1 to calculate deviations with respect to the commited electricity dispatch from previous runs';
QVGE_T_DOWN1(IY411,IA,IGE,IS3,T)$(NOT IGETOH(IGE) AND IAGK_HASORPOT(IY411,IA,IGE) AND GE_T(IY411,IA,IGE,IS3,T))..
VGE_T(IY411,IA,IGE,IS3,T)
=G=
GE_T(IY411,IA,IGE,IS3,T)
- VGE_T_DOWN(IY411,IA,IGE,IS3,T)
$ifi not %FORCEDDOWNREDISPATCH%==yes - IGE_T_DOWN_FORCED(IY411,IA,IGE,IS3,T)
;

EQUATION QVGE_T_DOWN2(YYY,AAA,GGG,SSS,TTT) 'Equation 2 to calulate deviations with respect to the commited electricity dispatch from previous runs';
QVGE_T_DOWN2(IY411,IA,IGE,IS3,T)$(NOT IGETOH(IGE) AND IAGK_HASORPOT(IY411,IA,IGE) AND GE_T(IY411,IA,IGE,IS3,T))..
GE_T(IY411,IA,IGE,IS3,T)
$ifi not %FORCEDDOWNREDISPATCH%==yes - IGE_T_DOWN_FORCED(IY411,IA,IGE,IS3,T)
=G=
VGE_T_DOWN(IY411,IA,IGE,IS3,T)
;

EQUATION QVGH_T_DOWN1(YYY,AAA,GGG,SSS,TTT) 'Equation 1 to calculate deviations with respect to the commited heat dispatch from previous runs';
QVGH_T_DOWN1(IY411,IA,IGH,IS3,T)$(IAGK_HASORPOT(IY411,IA,IGH)  AND GH_T(IY411,IA,IGH,IS3,T))..
VGH_T(IY411,IA,IGH,IS3,T)
=G=
GH_T(IY411,IA,IGH,IS3,T)
- VGH_T_DOWN(IY411,IA,IGH,IS3,T)
$ifi not %FORCEDDOWNREDISPATCH%==yes -IGH_T_DOWN_FORCED(IY411,IA,IGH,IS3,T)
;

EQUATION QVGH_T_DOWN2(YYY,AAA,GGG,SSS,TTT) 'Equation 2 to calculate deviations with respect to the commited heat dispatch from previous runs';
QVGH_T_DOWN2(IY411,IA,IGH,IS3,T)$(IAGK_HASORPOT(IY411,IA,IGH)  AND GH_T(IY411,IA,IGH,IS3,T))..
GH_T(IY411,IA,IGH,IS3,T)
$ifi not %FORCEDDOWNREDISPATCH%==yes -IGH_T_DOWN_FORCED(IY411,IA,IGH,IS3,T)
=G=
VGH_T_DOWN(IY411,IA,IGH,IS3,T)

;

$ifi not %HYDROGEN%==yes  $goto label_no_hydrogen
*Hydrogen
EQUATION QVGH2_T_DOWN1(YYY,AAA,GGG,SSS,TTT) 'Equation 1 to calculate deviations with respect to the commited hydrogen dispatch from previous runs';
QVGH2_T_DOWN1(IY411,IA,G,IS3,T)$(IAGK_HASORPOT(IY411,IA,G) AND IHYDROGEN(G) AND GH2_T(IY411,IA,G,IS3,T))..
(VGE_T(IY411,IA,G,IS3,T)*GDATA(G,'GDFE'))$(IHYDROGEN_GETOH2(G) OR IHYDROGEN_GETOHH2(G) OR IHYDROGEN_GEHTOH2(G))
 + (VHYDROGEN_GH2_T(IY411,IA,G,IS3,T))$(IHYDROGEN_GCH4TOH2(G) OR IHYDROGEN_GH2STO(G))
=G=
GH2_T(IY411,IA,G,IS3,T)
- VGH2_T_DOWN(IY411,IA,G,IS3,T)
$ifi not %FORCEDDOWNREDISPATCH%==yes - IGH2_T_DOWN_FORCED(IY411,IA,G,IS3,T)
;

EQUATION QVGH2_T_DOWN2(YYY,AAA,GGG,SSS,TTT) 'Equation 2 to calculate deviations with respect to the commited hydrogen dispatch from previous runs';
QVGH2_T_DOWN2(IY411,IA,IHYDROGEN,IS3,T)$(IAGK_HASORPOT(IY411,IA,IHYDROGEN) AND GH2_T(IY411,IA,IHYDROGEN,IS3,T))..
GH2_T(IY411,IA,IHYDROGEN,IS3,T)
$ifi not %FORCEDDOWNREDISPATCH%==yes - IGH2_T_DOWN_FORCED(IY411,IA,IHYDROGEN,IS3,T)
=G=
VGH2_T_DOWN(IY411,IA,IHYDROGEN,IS3,T)
;

*Synthetic natural gas
EQUATION QVGBIOMETHANE_T_DOWN1(YYY,AAA,GGG,SSS,TTT) 'Equation 1 to calculate deviations with respect to the commited synthetic natural gas dispatch from previous runs';
QVGBIOMETHANE_T_DOWN1(IY411,IA,IHYDROGEN_GH2TOBIOMETH,IS3,T)$(IAGK_HASORPOT(IY411,IA,IHYDROGEN_GH2TOBIOMETH) AND GBIOMETHANE_T(IY411,IA,IHYDROGEN_GH2TOBIOMETH,IS3,T))..
VGBIOMETH_T(IY411,IA,IHYDROGEN_GH2TOBIOMETH,IS3,T)
=G=
GBIOMETHANE_T(IY411,IA,IHYDROGEN_GH2TOBIOMETH,IS3,T)
- VGBIOMETHANE_T_DOWN(IY411,IA,IHYDROGEN_GH2TOBIOMETH,IS3,T)
$ifi not %FORCEDDOWNREDISPATCH%==yes - IGBIOMETHANE_T_DOWN_FORCED(IY411,IA,IHYDROGEN_GH2TOBIOMETH,IS3,T)
;

EQUATION QVGBIOMETHANE_T_DOWN2(YYY,AAA,GGG,SSS,TTT) 'Equation 2 to calculate deviations with respect to the commited synthetic natural gas dispatch from previous runs';
QVGBIOMETHANE_T_DOWN2(IY411,IA,IHYDROGEN_GH2TOBIOMETH,IS3,T)$(IAGK_HASORPOT(IY411,IA,IHYDROGEN_GH2TOBIOMETH) AND GBIOMETHANE_T(IY411,IA,IHYDROGEN_GH2TOBIOMETH,IS3,T))..
GBIOMETHANE_T(IY411,IA,IHYDROGEN_GH2TOBIOMETH,IS3,T)
$ifi not %FORCEDDOWNREDISPATCH%==yes - IGBIOMETHANE_T_DOWN_FORCED(IY411,IA,IHYDROGEN_GH2TOBIOMETH,IS3,T)
=G=
VGBIOMETHANE_T_DOWN(IY411,IA,IHYDROGEN_GH2TOBIOMETH,IS3,T)
;

*Biogas methanation
EQUATION QVGBIOGASMETHANATION_T_DOWN1(YYY,AAA,GGG,SSS,TTT) 'Equation 1 to calculate deviations with respect to the commited synthetic natural gas from biogas methanation dispatch from previous runs';
QVGBIOGASMETHANATION_T_DOWN1(IY411,IA,IHYDROGEN_GBIOGASMETHANATION,IS3,T)$(IAGK_HASORPOT(IY411,IA,IHYDROGEN_GBIOGASMETHANATION) AND GBIOGASMETHANATION_T(IY411,IA,IHYDROGEN_GBIOGASMETHANATION,IS3,T))..
VGBIOGASMETHANATION_T(IY411,IA,IHYDROGEN_GBIOGASMETHANATION,IS3,T)
=G=
GBIOGASMETHANATION_T(IY411,IA,IHYDROGEN_GBIOGASMETHANATION,IS3,T)
- VGBIOGASMETHANATION_T_DOWN(IY411,IA,IHYDROGEN_GBIOGASMETHANATION,IS3,T)
$ifi not %FORCEDDOWNREDISPATCH%==yes - IGBIOGASMETHANATION_T_DOWN_FORCED(IY411,IA,IHYDROGEN_GBIOGASMETHANATION,IS3,T)
;

EQUATION QVGBIOGASMETHANATION_T_DOWN2(YYY,AAA,GGG,SSS,TTT) 'Equation 2 to calculate deviations with respect to the commited synthetic natural gas from biogas methanation dispatch from previous runs';
QVGBIOGASMETHANATION_T_DOWN2(IY411,IA,IHYDROGEN_GBIOGASMETHANATION,IS3,T)$(IAGK_HASORPOT(IY411,IA,IHYDROGEN_GBIOGASMETHANATION) AND GBIOGASMETHANATION_T(IY411,IA,IHYDROGEN_GBIOGASMETHANATION,IS3,T))..
GBIOGASMETHANATION_T(IY411,IA,IHYDROGEN_GBIOGASMETHANATION,IS3,T)
$ifi not %FORCEDDOWNREDISPATCH%==yes - IGBIOGASMETHANATION_T_DOWN_FORCED(IY411,IA,IHYDROGEN_GBIOGASMETHANATION,IS3,T)
=G=
VGBIOGASMETHANATION_T_DOWN(IY411,IA,IHYDROGEN_GBIOGASMETHANATION,IS3,T)
;

*Biogas upgrading
EQUATION QVGBIOGASUPGRADING_T_DOWN1(YYY,AAA,GGG,SSS,TTT) 'Equation 1 to calculate deviations with respect to the commited synthetic natural gas dispatch from biogas upgrading from previous runs';
QVGBIOGASUPGRADING_T_DOWN1(IY411,IA,IHYDROGEN_GBIOGASUPGRADING,IS3,T)$(IAGK_HASORPOT(IY411,IA,IHYDROGEN_GBIOGASUPGRADING) AND GBIOGASUPGRADING_T(IY411,IA,IHYDROGEN_GBIOGASUPGRADING,IS3,T))..
VGBIOGASUPGRADING_T(IY411,IA,IHYDROGEN_GBIOGASUPGRADING,IS3,T)
=G=
GBIOGASUPGRADING_T(IY411,IA,IHYDROGEN_GBIOGASUPGRADING,IS3,T)
- VGBIOGASUPGRADING_T_DOWN(IY411,IA,IHYDROGEN_GBIOGASUPGRADING,IS3,T)
$ifi not %FORCEDDOWNREDISPATCH%==yes - IGBIOGASUPGRADING_T_DOWN_FORCED(IY411,IA,IHYDROGEN_GBIOGASUPGRADING,IS3,T)
;

EQUATION QVGBIOGASUPGRADING_T_DOWN2(YYY,AAA,GGG,SSS,TTT) 'Equation 2 to calculate deviations with respect to the commited synthetic natural gas from biogas upgrading dispatch from previous runs';
QVGBIOGASUPGRADING_T_DOWN2(IY411,IA,IHYDROGEN_GBIOGASUPGRADING,IS3,T)$(IAGK_HASORPOT(IY411,IA,IHYDROGEN_GBIOGASUPGRADING) AND GBIOGASUPGRADING_T(IY411,IA,IHYDROGEN_GBIOGASUPGRADING,IS3,T))..
GBIOGASUPGRADING_T(IY411,IA,IHYDROGEN_GBIOGASUPGRADING,IS3,T)
$ifi not %FORCEDDOWNREDISPATCH%==yes - IGBIOGASUPGRADING_T_DOWN_FORCED(IY411,IA,IHYDROGEN_GBIOGASUPGRADING,IS3,T)
=G=
VGBIOGASUPGRADING_T_DOWN(IY411,IA,IHYDROGEN_GBIOGASUPGRADING,IS3,T)
;

$label label_no_hydrogen

$label NO_TSOREDISPATCH






